<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OT/å‡æœŸ è¨˜éŒ„ç³»çµ± (2026)</title>
    
    <link rel="apple-touch-icon" href="icon.png"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="OTè¨˜éŒ„">
    <style>
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #333;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); 
            margin: 0; 
            padding: 10px; 
            color: var(--text-main);
            padding-bottom: 80px; 
            -webkit-tap-highlight-color: transparent;
        }
        
        button:active, .calendar-day:active, select:active { transform: scale(0.98); }

        /* é ‚éƒ¨å„€è¡¨æ¿ */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .stat-card { background: var(--card-bg); padding: 12px 5px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-value { font-size: 1.3rem; font-weight: 800; display: block; margin-bottom: 2px; }
        .stat-label { font-size: 0.75rem; color: #666; font-weight: 500; }
        .text-green { color: var(--success-color); }
        .text-red { color: var(--danger-color); }

        /* æœˆæ›†æ¨£å¼ */
        .calendar-container { background: var(--card-bg); padding: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-header h3 { margin: 0; font-size: 1.2rem; }
        .cal-btn { background: #eee; border: none; border-radius: 8px; padding: 5px 15px; font-weight: bold; font-size: 1.2rem; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .calendar-day-name { font-weight: bold; font-size: 0.8rem; color: #888; padding-bottom: 5px; }
        .calendar-day { 
            padding: 4px 2px; border-radius: 10px; cursor: pointer; min-height: 45px; 
            border: 1px solid transparent; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #fdfdfd;
        }
        .calendar-day.selected { background-color: var(--primary-color) !important; color: white !important; border-color: var(--primary-color); box-shadow: 0 4px 8px rgba(0,123,255,0.3); }
        .calendar-day.today { border: 2px solid var(--primary-color); font-weight: bold; }
        .calendar-day.sunday { color: var(--danger-color); }
        .calendar-day.holiday { color: var(--danger-color); }
        
        .holiday-name { font-size: 0.6rem; line-height: 1.1; margin-top: 2px; color: #d63384; transform: scale(0.9); font-weight: normal; }
        .calendar-day.selected .holiday-name { color: rgba(255,255,255,0.9); }
        
        .dot { width: 5px; height: 5px; background-color: var(--primary-color); border-radius: 50%; position: absolute; bottom: 4px; }
        .calendar-day.selected .dot { background-color: white; }

        /* è¼¸å…¥å€æ¨£å¼ */
        .input-section { background: var(--card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); position: fixed; bottom: 0; left: 0; width: 100%; box-sizing: border-box; z-index: 900; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); border-top: 1px solid #eee; }
        .input-section.active { transform: translateY(0); }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; color: #444; }
        
        select, input { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: #fff; appearance: none; -webkit-appearance: none; }
        select { background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; }

        button.btn-primary { width: 100%; padding: 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,123,255,0.2); }
        .btn-close { position: absolute; top: 15px; right: 15px; background: #f0f0f0; border: none; border-radius: 50%; width: 30px; height: 30px; font-weight: bold; color: #666; font-size: 1.2rem; line-height: 30px; text-align: center; }

        .record-list { background: var(--card-bg); border-radius: 15px; margin-top: 20px; overflow: hidden; margin-bottom: 80px; }
        .record-item { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .record-info { font-size: 0.95rem; }
        .record-delete { color: #999; background: none; border: none; padding: 10px; font-size: 1.2rem; }

        /* å½ˆçª— Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal.show { display: flex; animation: fadeIn 0.2s; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-content h3 { margin-top: 0; color: var(--danger-color); }
        
        .settings-btn { position: fixed; top: 10px; right: 10px; width: 40px; height: 40px; border-radius: 50%; background: white; color: #333; font-size: 20px; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; cursor: pointer; border: 1px solid #eee; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="settings-btn" onclick="tap(); openSettings()">âš™ï¸</div>

    <div class="dashboard">
        <div class="stat-card">
            <span class="stat-value" id="balanceAL">--</span>
            <span class="stat-label">å¹´å‡ (æ—¥)</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="balancePH">--</span>
            <span class="stat-label">è£œå‡ (æ—¥)</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="balanceOT">--</span>
            <span class="stat-label">OT/æ¬ é˜</span>
        </div>
    </div>

    <div class="calendar-container">
        <div class="calendar-header">
            <button class="cal-btn" onclick="tap(); changeMonth(-1)">&lt;</button>
            <h3 id="currentMonthLabel">2026å¹´ 2æœˆ</h3>
            <button class="cal-btn" onclick="tap(); changeMonth(1)">&gt;</button>
        </div>
        <div class="calendar-grid">
            <div class="calendar-day-name sunday">æ—¥</div>
            <div class="calendar-day-name">ä¸€</div>
            <div class="calendar-day-name">äºŒ</div>
            <div class="calendar-day-name">ä¸‰</div>
            <div class="calendar-day-name">å››</div>
            <div class="calendar-day-name">äº”</div>
            <div class="calendar-day-name">å…­</div>
            <div id="calendarDays" class="calendar-grid" style="display: contents;"></div>
        </div>
    </div>

    <h4 style="margin: 0 10px; color: #666;">æœ€è¿‘è¨˜éŒ„</h4>
    <div class="record-list" id="recordList"></div>

    <div id="inputSection" class="input-section">
        <button class="btn-close" onclick="tap(); closeInput()">Ã—</button>
        <h3 style="margin-top: 0; font-size: 1.1rem;">ğŸ“… <span id="selectedDateLabel"></span></h3>
        
        <div class="form-group">
            <label>é¡åˆ¥é¸æ“‡</label>
            <select id="typeSelect" onchange="tap(); updateFormUI()">
                <option value="OT">âš¡ OT (åŠ ç­)</option>
                <option value="Comp">ğŸ“‰ è£œé˜</option>
                <option value="PH">ğŸ–ï¸ è£œå‡ (PH)</option>
                <option value="AL">ğŸŒ´ å¹´å‡ (AL)</option>
            </select>
        </div>

        <div id="formOT" class="form-group">
            <label>åŠ ç­æ™‚æ•¸</label>
            <select id="hoursOT" onchange="tap()"></select>
        </div>

        <div id="formComp" class="form-group" style="display:none;">
            <label>è£œé˜æ™‚æ•¸</label>
            <select id="hoursComp" onchange="tap()"></select>
        </div>

        <div id="formPH" class="form-group" style="display:none;">
            <label>ä¾†æºå‡æœŸ (å…¬çœ¾å‡æœŸ)</label>
            <select id="sourcePH" onchange="tap(); checkPHValidity()"></select>
            <div id="phWarning" style="color:red; font-size:0.8rem; margin-top:5px; display:none;"></div>
        </div>

        <div id="formAL" class="form-group" style="display:none;">
            <div style="background:#e3f2fd; padding:15px; border-radius:10px; color:#0d47a1; text-align:center;">
                ç¢ºèªè¨˜éŒ„å¹´å‡ï¼Ÿå°‡æ‰£é™¤ 1 æ—¥é¡åº¦ã€‚
            </div>
        </div>

        <div class="form-group">
            <label>å‚™è¨»</label>
            <input type="text" id="remarks" placeholder="å¦‚æœ‰: å¯é¸æ“‡å¡«å¯«">
        </div>

        <button onclick="tap(); saveRecord()" class="btn-primary">ç¢ºèªè¨˜éŒ„</button>
    </div>

    <div id="disclaimerModal" class="modal">
        <div class="modal-content">
            <h3>âš ï¸ å…è²¬è²æ˜</h3>
            <p style="font-size: 0.9rem; color: #555; text-align: left; line-height: 1.5;">
                æ­¤è¡¨æ ¼åƒ…ä½œå¯¦é©—ç”¨é€”ã€‚<br><br>
                è«‹å„ä½<b>ç§ä¸‹å†ä½œå¦å¤–è¨˜éŒ„</b>ã€‚<br><br>
                å¦‚å› æ­¤è¡¨æ ¼å› ä»»ä½•æƒ…æ³å´©æ½°æˆ–éºå¤±è³‡æ–™ï¼Œé–‹ç™¼è€…ä¸€æ¦‚ä¸¦ä¸è² è²¬ã€‚
            </p>
            <button class="btn-primary" onclick="tap(); closeDisclaimer()">æˆ‘æ˜ç™½ä¸¦åŒæ„</button>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h3 style="color:#333">âš™ï¸ è¨­å®š</h3>
            <p>æ¯å¹´å¹´å‡ (AL) é¡åº¦ï¼š</p>
            <select id="alQuotaSelect" onchange="tap()" style="margin-bottom: 20px;">
                <option value="12">12 æ—¥</option>
                <option value="14">14 æ—¥</option>
                <option value="17">17 æ—¥</option>
            </select>
            <button class="btn-primary" onclick="tap(); saveSettings()">å„²å­˜è¨­å®š</button>
            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <button onclick="tap(); resetAll()" style="background:white; color:red; border:1px solid red; padding:10px; width:100%; border-radius:8px;">âš ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>
            </div>
            <button onclick="tap(); document.getElementById('settingsModal').classList.remove('show')" style="margin-top:10px; background:none; border:none; color:#666;">é—œé–‰</button>
        </div>
    </div>

<script>
    // --- 0. éŸ³æ•ˆèˆ‡éœ‡å‹• ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    function tap() {
        if (navigator.vibrate) navigator.vibrate(15);
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.05);
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.05);
    }

    // --- 1. è³‡æ–™åº«é…ç½® ---
    const DB_KEY = 'ot_system_data_v2';
    const SETTINGS_KEY = 'ot_system_settings_v2';
    
    const holidays2026 = {
        '1/1': 'å…ƒæ—¦', '2/17': 'å¹´åˆä¸€', '2/18': 'å¹´åˆäºŒ', '2/19': 'å¹´åˆä¸‰',
        '4/3': 'è€¶ç©Œå—é›£', '4/4': 'å—é›£ç¿Œæ—¥', '4/6': 'æ¸…æ˜ç¿Œæ—¥', '4/7': 'å¾©æ´»ç¿Œæ—¥',
        '5/1': 'å‹å‹•ç¯€', '5/25': 'ä½›èª•ç¿Œæ—¥', '6/19': 'ç«¯åˆç¯€', '7/1': 'å›æ­¸',
        '9/26': 'ä¸­ç§‹ç¿Œæ—¥', '10/1': 'åœ‹æ…¶', '10/19': 'é‡é™½', '12/25': 'è–èª•', '12/26': 'è–èª•ç¿Œæ—¥'
    };

    const holidayDates = {
        'å…ƒæ—¦': '2026-01-01', 'å¹´åˆä¸€': '2026-02-17', 'å¹´åˆäºŒ': '2026-02-18', 'å¹´åˆä¸‰': '2026-02-19',
        'è€¶ç©Œå—é›£': '2026-04-03', 'å—é›£ç¿Œæ—¥': '2026-04-04', 'æ¸…æ˜ç¿Œæ—¥': '2026-04-06', 'å¾©æ´»ç¿Œæ—¥': '2026-04-07',
        'å‹å‹•ç¯€': '2026-05-01', 'ä½›èª•ç¿Œæ—¥': '2026-05-25', 'ç«¯åˆç¯€': '2026-06-19', 'å›æ­¸': '2026-07-01',
        'ä¸­ç§‹ç¿Œæ—¥': '2026-09-26', 'åœ‹æ…¶': '2026-10-01', 'é‡é™½': '2026-10-19', 'è–èª•': '2026-12-25', 'è–èª•ç¿Œæ—¥': '2026-12-26'
    };

    let currentDate = new Date(2026, 1, 1);
    let selectedDateStr = '';
    let appData = [];
    let userSettings = { alQuota: 14 };

    // --- 2. åˆå§‹åŒ– ---
    window.onload = function() {
        document.getElementById('disclaimerModal').classList.add('show');
        loadData();
        renderCalendar();
        initTimeOptions();
        document.body.addEventListener('touchstart', function() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }, {once:true});
    };

    function closeDisclaimer() {
        document.getElementById('disclaimerModal').classList.remove('show');
        if (!localStorage.getItem(SETTINGS_KEY)) openSettings();
    }

    function loadData() {
        const savedData = localStorage.getItem(DB_KEY);
        if (savedData) appData = JSON.parse(savedData);
        const savedSettings = localStorage.getItem(SETTINGS_KEY);
        if (savedSettings) userSettings = JSON.parse(savedSettings);
        calculateBalance();
        renderRecords();
    }

    function initTimeOptions() {
        const otSelect = document.getElementById('hoursOT');
        otSelect.innerHTML = '';
        for (let i = 0.5; i <= 8.0; i += 0.5) otSelect.innerHTML += `<option value="${i}">${i} å°æ™‚</option>`;
        const compSelect = document.getElementById('hoursComp');
        compSelect.innerHTML = '';
        for (let i = 0.5; i <= 5.0; i += 0.5) compSelect.innerHTML += `<option value="${i}">${i} å°æ™‚</option>`;
    }

    // --- 3. ä»‹é¢é‚è¼¯ ---
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        document.getElementById('currentMonthLabel').innerText = `${year}å¹´ ${month + 1}æœˆ`;
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDayIndex = firstDay.getDay();

        const container = document.getElementById('calendarDays');
        container.innerHTML = '';

        for (let i = 0; i < startDayIndex; i++) container.innerHTML += `<div></div>`;

        for (let day = 1; day <= lastDay.getDate(); day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const shortKey = `${month + 1}/${day}`;
            const holidayName = holidays2026[shortKey] || '';
            const isSunday = new Date(year, month, day).getDay() === 0;
            const isSelected = dateStr === selectedDateStr;
            const hasRecord = appData.some(r => r.date === dateStr);

            let classes = `calendar-day ${isSunday ? 'sunday' : ''} ${holidayName ? 'holiday' : ''} ${isSelected ? 'selected' : ''}`;

            container.innerHTML += `
                <div class="${classes}" onclick="tap(); selectDate('${dateStr}')">
                    <span>${day}</span>
                    ${holidayName ? `<span class="holiday-name">${holidayName}</span>` : ''}
                    ${hasRecord ? '<div class="dot"></div>' : ''}
                </div>
            `;
        }
    }

    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    }

    function selectDate(dateStr) {
        selectedDateStr = dateStr;
        renderCalendar();
        const inputSec = document.getElementById('inputSection');
        inputSec.classList.add('active');
        
        let label = dateStr;
        const d = new Date(dateStr);
        const shortKey = `${d.getMonth()+1}/${d.getDate()}`;
        if (holidays2026[shortKey]) label += ` (${holidays2026[shortKey]})`;
        
        document.getElementById('selectedDateLabel').innerText = label;
        updateFormUI(); 
    }

    function closeInput() {
        document.getElementById('inputSection').classList.remove('active');
        selectedDateStr = '';
        renderCalendar();
    }

    function updateFormUI() {
        const type = document.getElementById('typeSelect').value;
        document.getElementById('formOT').style.display = type === 'OT' ? 'block' : 'none';
        document.getElementById('formComp').style.display = type === 'Comp' ? 'block' : 'none';
        document.getElementById('formPH').style.display = type === 'PH' ? 'block' : 'none';
        document.getElementById('formAL').style.display = type === 'AL' ? 'block' : 'none';

        if (type === 'PH') updatePHOptions();
    }

    function updatePHOptions() {
        const phSelect = document.getElementById('sourcePH');
        phSelect.innerHTML = ''; 

        const usedHolidays = new Set(appData.filter(r => r.type === 'PH').map(r => r.sourcePH));
        const selectedDate = new Date(selectedDateStr);

        for (const [name, dateStr] of Object.entries(holidayDates)) {
            const hDate = new Date(dateStr);
            const isUsed = usedHolidays.has(name);
            const isFuture = hDate > selectedDate; // æª¢æŸ¥å‡æœŸæ˜¯å¦é²éæ‰€é¸æ—¥æœŸ

            let labelText = `${name} (${dateStr})`;
            let disabledAttr = '';
            let style = '';

            if (isUsed) {
                labelText = `${name} (å·²æ”¾)`;
                disabledAttr = 'disabled';
                style = 'color:#aaa';
            } else if (isFuture) {
                labelText = `${name} (æœªç™¼ç”Ÿ)`;
                disabledAttr = 'disabled'; // ç¦æ­¢é¸æ“‡æœªç™¼ç”Ÿçš„å‡æœŸ
                style = 'color:#ddd';
            }
            
            phSelect.innerHTML += `<option value="${name}" ${disabledAttr} style="${style}">${labelText}</option>`;
        }
        checkPHValidity();
    }

    function checkPHValidity() {
        if (!selectedDateStr) return;
        const holidayName = document.getElementById('sourcePH').value;
        const warning = document.getElementById('phWarning');
        
        if (!holidayName) { warning.style.display = 'none'; return; }

        const hDate = new Date(holidayDates[holidayName]);
        const aDate = new Date(selectedDateStr);
        
        // é¡å¤–æª¢æŸ¥ï¼šå¦‚æœç”¨æˆ¶ç”¨æŸç¨®æ–¹æ³•é¸äº†æœªä¾†æ—¥æœŸ
        if (aDate < hDate) {
            warning.style.display = 'block';
            warning.innerText = `âŒ éŒ¯èª¤ï¼šè£œå‡æ—¥å­ä¸èƒ½æ—©æ–¼è©²å…¬çœ¾å‡æœŸï¼`;
            return;
        }

        const diffDays = Math.ceil(Math.abs(aDate - hDate) / (1000 * 60 * 60 * 24));

        if (diffDays > 60) {
            warning.style.display = 'block';
            warning.innerText = `âš ï¸ æç¤ºï¼šèˆ‡å‡æœŸç›¸å·® ${diffDays} æ—¥ï¼Œå·²è¶…é 60 æ—¥é™æœŸï¼`;
        } else {
            warning.style.display = 'none';
        }
    }

    // --- 4. å„²å­˜èˆ‡é‚è¼¯ ---
    function saveRecord() {
        if (!selectedDateStr) return;
        const type = document.getElementById('typeSelect').value;
        let hours = 0, days = 0, sourcePH = '', remarks = document.getElementById('remarks').value;

        if (type === 'OT') hours = parseFloat(document.getElementById('hoursOT').value);
        else if (type === 'Comp') hours = -parseFloat(document.getElementById('hoursComp').value);
        else if (type === 'PH') {
            sourcePH = document.getElementById('sourcePH').value;
            if (!sourcePH) { alert("ç„¡æ•ˆçš„å‡æœŸé¸æ“‡ (å·²ç”¨ç›¡æˆ–æœªç™¼ç”Ÿ)"); return; }
            
            // å®‰å…¨æª¢æŸ¥ï¼šé˜²æ­¢æ—©æ–¼å‡æœŸ
            const hDate = new Date(holidayDates[sourcePH]);
            const aDate = new Date(selectedDateStr);
            if (aDate < hDate) {
                alert("âŒ éŒ¯èª¤ï¼šè£œå‡æ—¥å­ä¸èƒ½æ—©æ–¼è©²å…¬çœ¾å‡æœŸï¼");
                return;
            }

            days = -1;
            remarks = `[è£œ] ${sourcePH} ` + remarks;
        } 
        else if (type === 'AL') {
            days = -1;
            remarks = `[å¹´å‡] ` + remarks;
        }

        appData.unshift({
            id: Date.now(),
            date: selectedDateStr,
            type: type,
            hours: hours,
            days: days,
            sourcePH: sourcePH, 
            remarks: remarks
        });

        localStorage.setItem(DB_KEY, JSON.stringify(appData));
        closeInput();
        loadData();
    }

    function deleteRecord(id) {
        if (!confirm("ç¢ºå®šåˆªé™¤æ­¤è¨˜éŒ„ï¼Ÿ")) return;
        appData = appData.filter(r => r.id !== id);
        localStorage.setItem(DB_KEY, JSON.stringify(appData));
        loadData();
        renderCalendar();
    }

    function calculateBalance() {
        let balOT = 0, phUsed = 0, alUsed = 0;
        appData.forEach(r => {
            if (r.type === 'OT' || r.type === 'Comp') balOT += r.hours;
            if (r.type === 'PH') phUsed += 1;
            if (r.type === 'AL') alUsed += 1;
        });

        const elOT = document.getElementById('balanceOT');
        if (balOT > 0) {
            elOT.innerHTML = `OT: +${balOT}<small> hrs</small>`;
            elOT.className = 'stat-value text-green';
        } else if (balOT < 0) {
            elOT.innerHTML = `æ¬ : ${balOT}<small> hrs</small>`;
            elOT.className = 'stat-value text-red';
        } else {
            elOT.innerHTML = `0`;
            elOT.className = 'stat-value';
        }

        document.getElementById('balancePH').innerHTML = `${17 - phUsed} <small>/ 17</small>`;
        document.getElementById('balanceAL').innerHTML = `${userSettings.alQuota - alUsed} <small>/ ${userSettings.alQuota}</small>`;
    }

    function renderRecords() {
        const list = document.getElementById('recordList');
        list.innerHTML = '';
        const sorted = [...appData].sort((a,b) => new Date(b.date) - new Date(a.date));

        sorted.forEach(r => {
            let val = (r.type === 'OT' || r.type === 'Comp') ? `${r.hours} hrs` : '1 æ—¥';
            let color = r.hours > 0 ? 'green' : (r.hours < 0 ? 'orange' : '#333');
            if (r.type === 'PH') color = '#d63384';
            if (r.type === 'AL') color = 'blue';

            list.innerHTML += `
                <div class="record-item">
                    <div class="record-info">
                        <strong>${r.date}</strong> <span style="color:${color};font-weight:bold;margin-left:5px;">${r.type}</span> <span style="font-size:0.8rem;color:#888;">${val}</span><br>
                        <span style="color:#666; font-size:0.85rem;">${r.remarks || ''}</span>
                    </div>
                    <button class="record-delete" onclick="tap(); deleteRecord(${r.id})">Ã—</button>
                </div>
            `;
        });
    }

    // --- 5. è¨­å®š ---
    function openSettings() {
        document.getElementById('settingsModal').classList.add('show');
        document.getElementById('alQuotaSelect').value = userSettings.alQuota;
    }
    function saveSettings() {
        userSettings.alQuota = parseInt(document.getElementById('alQuotaSelect').value);
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(userSettings));
        document.getElementById('settingsModal').classList.remove('show');
        loadData();
    }
    function resetAll() {
        if (confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰è¨˜éŒ„ï¼ç„¡æ³•å¾©åŸï¼")) {
            localStorage.removeItem(DB_KEY);
            location.reload();
        }
    }
</script>
</body>
</html>