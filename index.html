<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OT/å‡æœŸ è¨˜éŒ„ç³»çµ± (V14)</title>
    
    <link rel="apple-touch-icon" href="icon.png"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="OTè¨˜éŒ„">
    <style>
        :root {
            --primary-color: #007bff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --bg-color: #f2f3f5;
            --card-bg: #ffffff;
            --text-main: #333;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); 
            margin: 0; 
            padding: 10px; 
            color: var(--text-main);
            padding-bottom: 120px; 
            -webkit-tap-highlight-color: transparent;
        }
        
        button:active, .calendar-day:active, select:active { transform: scale(0.98); }

        /* å„€è¡¨æ¿ - ä¿®å¾©æ›è¡Œå•é¡Œ */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 15px; }
        .stat-card { background: var(--card-bg); padding: 10px 4px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; }
        
        /* å¼·åˆ¶å–®è¡Œé¡¯ç¤º */
        .stat-value { 
            font-size: 1.1rem; /* ç¨å¾®èª¿å°ä»¥é©æ‡‰çª„å± */
            font-weight: 800; 
            display: block; 
            margin-bottom: 2px;
            white-space: nowrap; /* æ ¸å¿ƒä¿®å¾©ï¼šä¸å‡†æ›è¡Œ */
            overflow: hidden;
            text-overflow: ellipsis; 
        }
        .stat-label { font-size: 0.7rem; color: #666; font-weight: 500; white-space: nowrap; }
        
        .text-green { color: var(--success-color); }
        .text-red { color: var(--danger-color); }
        .text-blue { color: var(--primary-color); }

        /* æœˆæ›†çµæ§‹ */
        .calendar-container { background: var(--card-bg); padding: 15px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; min-height: 300px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-header h3 { margin: 0; font-size: 1.2rem; }
        .cal-btn { background: #eee; border: none; border-radius: 8px; padding: 5px 15px; font-weight: bold; font-size: 1.2rem; }
        
        .week-header { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; margin-bottom: 5px; }
        .calendar-day-name { font-weight: bold; font-size: 0.8rem; color: #888; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .calendar-day { 
            padding: 4px 2px; border-radius: 10px; cursor: pointer; min-height: 45px; 
            border: 1px solid transparent; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #fdfdfd; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .calendar-day.selected { background-color: var(--primary-color) !important; color: white !important; border-color: var(--primary-color); box-shadow: 0 4px 8px rgba(0,123,255,0.3); }
        .calendar-day.today { border: 2px solid var(--primary-color); font-weight: bold; }
        .calendar-day.sunday { color: var(--danger-color); }
        .calendar-day.holiday { color: var(--danger-color); }
        
        .holiday-name { font-size: 0.6rem; line-height: 1.1; margin-top: 2px; color: #d63384; transform: scale(0.9); font-weight: normal; }
        .calendar-day.selected .holiday-name { color: rgba(255,255,255,0.9); }
        .dot { width: 5px; height: 5px; background-color: var(--primary-color); border-radius: 50%; position: absolute; bottom: 4px; }
        .calendar-day.selected .dot { background-color: white; }

        /* åˆ—è¡¨å€ */
        .record-list { background: var(--card-bg); border-radius: 15px; margin-top: 10px; overflow: hidden; padding: 10px; }
        .record-item { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; background: #fff; margin-bottom: 8px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .record-info { font-size: 0.95rem; line-height: 1.4; }
        
        /* åˆªé™¤æŒ‰éˆ•æ¨£å¼ */
        .record-actions button { 
            background: #fff0f0; 
            border: 1px solid #ffcccc; 
            padding: 8px 12px; 
            font-size: 0.9rem; 
            cursor: pointer; 
            border-radius: 8px; 
            color: var(--danger-color);
            font-weight: bold;
        }
        .record-actions button:active { background: var(--danger-color); color: white; }

        /* è¼¸å…¥å€ (Popup) */
        .input-section { background: var(--card-bg); padding: 25px 20px; border-radius: 20px 20px 0 0; box-shadow: 0 -4px 30px rgba(0,0,0,0.15); position: fixed; bottom: 0; left: 0; width: 100%; box-sizing: border-box; z-index: 900; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); border-top: 1px solid #eee; display: flex; flex-direction: column; max-height: 90vh; overflow-y: auto; }
        .input-section.active { transform: translateY(0); }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.95rem; color: #444; }
        
        select, input { width: 100%; padding: 14px; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; box-sizing: border-box; background-color: #fff; appearance: none; -webkit-appearance: none; }
        select { background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; }
        select:invalid, select option[value=""] { color: #999; }

        button.btn-primary { width: 100%; padding: 16px; background-color: var(--primary-color); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; margin-top: 10px; box-shadow: 0 4px 10px rgba(0,123,255,0.3); }
        button:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; }
        
        .btn-close { position: absolute; top: 15px; right: 15px; background: #f0f0f0; border: none; border-radius: 50%; width: 35px; height: 35px; font-weight: bold; color: #666; font-size: 1.5rem; line-height: 35px; text-align: center; cursor: pointer; }

        .hidden { display: none !important; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal.show { display: flex; animation: fadeIn 0.2s; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        .settings-btn { position: fixed; top: 10px; right: 10px; width: 40px; height: 40px; border-radius: 50%; background: white; color: #333; font-size: 20px; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; cursor: pointer; border: 1px solid #eee; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="settings-btn" onclick="tap(); openSettings()">âš™ï¸</div>

    <div class="dashboard">
        <div class="stat-card">
            <span class="stat-value" id="balanceAL">--</span>
            <span class="stat-label">å¹´å‡ (æ—¥)</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="balancePH">--</span>
            <span class="stat-label">è£œå‡ (æ—¥)</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="balanceOT">--</span>
            <span class="stat-label">OT/æ¬ é˜</span>
        </div>
    </div>

    <div class="calendar-container">
        <div class="calendar-header">
            <button class="cal-btn" onclick="tap(); changeMonth(-1)">&lt;</button>
            <h3 id="currentMonthLabel">2026å¹´ 2æœˆ</h3>
            <button class="cal-btn" onclick="tap(); changeMonth(1)">&gt;</button>
        </div>
        <div class="week-header">
            <div class="calendar-day-name sunday">æ—¥</div>
            <div class="calendar-day-name">ä¸€</div>
            <div class="calendar-day-name">äºŒ</div>
            <div class="calendar-day-name">ä¸‰</div>
            <div class="calendar-day-name">å››</div>
            <div class="calendar-day-name">äº”</div>
            <div class="calendar-day-name">å…­</div>
        </div>
        <div id="calendarDays" class="calendar-grid"></div>
    </div>

    <div style="padding: 0 10px; display:flex; justify-content:space-between; align-items:center;">
        <h4 style="margin: 0; color: #666;">æœ€è¿‘è¨˜éŒ„</h4>
    </div>
    <div class="record-list" id="recordList"></div>

    <div id="inputSection" class="input-section">
        <button class="btn-close" onclick="tap(); closeInput()">Ã—</button>
        
        <h3 style="margin-top: 0; font-size: 1.3rem; margin-bottom: 20px; text-align: center;">
            <span id="formTitle">æ–°å¢è¨˜éŒ„</span>
        </h3>
        
        <div style="text-align: center; margin-bottom: 20px; font-size: 1.1rem; color: #555; font-weight: bold;">
            <span id="selectedDateLabel">--</span>
        </div>

        <div class="form-group">
            <label>é¡åˆ¥é¸æ“‡</label>
            <select id="typeSelect" onchange="tap(); updateFormUI()">
                <option value="" disabled selected>-- è«‹é¸æ“‡é¡åˆ¥ --</option>
                <option value="OT">âš¡ OT (åŠ ç­)</option>
                <option value="Comp">ğŸ“‰ è£œé˜</option>
                <option value="PH">ğŸ–ï¸ è£œå‡ (PH)</option>
                <option value="AL">ğŸŒ´ å¹´å‡ (AL)</option>
            </select>
        </div>

        <div id="formOT" class="form-group hidden">
            <label>åŠ ç­æ™‚æ•¸</label>
            <select id="hoursOT" onchange="tap()"></select>
        </div>

        <div id="formComp" class="form-group hidden">
            <label>è£œé˜æ™‚æ•¸</label>
            <select id="hoursComp" onchange="tap()"></select>
        </div>

        <div id="formPH" class="form-group hidden">
            <label>ä¾†æºå‡æœŸ (å…¬çœ¾å‡æœŸ)</label>
            <select id="sourcePH" onchange="tap(); checkPHValidity()"></select>
            <div id="phWarning" style="color:red; font-size:0.8rem; margin-top:5px; display:none; font-weight:bold;"></div>
        </div>

        <div id="formAL" class="form-group hidden">
            <div style="background:#e3f2fd; padding:15px; border-radius:10px; color:#0d47a1; text-align:center;">
                <p style="margin:5px 0; font-weight:bold;">ç¢ºèªè¨˜éŒ„å¹´å‡ï¼Ÿ</p>
                <p style="margin:0; font-size:0.9rem;">(å°‡æ‰£é™¤ 1 æ—¥)</p>
            </div>
        </div>

        <div class="form-group">
            <label>å‚™è¨»</label>
            <input type="text" id="remarks" placeholder="å¦‚æœ‰: å¯é¸æ“‡å¡«å¯«">
        </div>

        <button id="saveBtn" onclick="tap(); saveRecord()" class="btn-primary">ç¢ºèªè¨˜éŒ„</button>
    </div>

    <div id="disclaimerModal" class="modal">
        <div class="modal-content">
            <h3>âš ï¸ å…è²¬è²æ˜</h3>
            <p style="font-size: 0.9rem; color: #555; text-align: left; line-height: 1.5;">
                æ­¤è¡¨æ ¼åƒ…ä½œå¯¦é©—ç”¨é€”ã€‚<br><br>
                è«‹å„ä½<b>ç§ä¸‹å†ä½œå¦å¤–è¨˜éŒ„</b>ã€‚<br><br>
                å¦‚å› æ­¤è¡¨æ ¼å› ä»»ä½•æƒ…æ³å´©æ½°æˆ–éºå¤±è³‡æ–™ï¼Œé–‹ç™¼è€…ä¸€æ¦‚ä¸¦ä¸è² è²¬ã€‚
            </p>
            <button class="btn-primary" onclick="tap(); closeDisclaimer()">æˆ‘æ˜ç™½ä¸¦åŒæ„</button>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h3 style="color:#333">âš™ï¸ è¨­å®š</h3>
            <div style="text-align:left; margin-bottom:15px;">
                <label>1. æ¯å¹´å¹´å‡ (AL) é¡åº¦</label>
                <select id="alQuotaSelect" onchange="tap()">
                    <option value="12">12 æ—¥</option>
                    <option value="14">14 æ—¥</option>
                    <option value="17">17 æ—¥</option>
                </select>
            </div>
            <div style="text-align:left; margin-bottom:15px;">
                <label>2. ä¸Šå¹´å‰©é¤˜å¹´å‡ (Carry Forward)</label>
                <select id="alCarrySelect" onchange="tap()">
                    <option value="0">0 æ—¥</option>
                    <option value="1">1 æ—¥</option>
                    <option value="2">2 æ—¥</option>
                    <option value="3">3 æ—¥</option>
                </select>
            </div>
            <button class="btn-primary" onclick="tap(); saveSettings()">å„²å­˜è¨­å®š</button>
            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <button onclick="tap(); resetAll()" style="background:white; color:red; border:1px solid red; padding:10px; width:100%; border-radius:8px;">âš ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>
            </div>
            <button onclick="tap(); document.getElementById('settingsModal').classList.remove('show')" style="margin-top:10px; background:none; border:none; color:#666;">é—œé–‰</button>
        </div>
    </div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function tap() {
        if (navigator.vibrate) navigator.vibrate(15);
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.05);
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.05);
    }

    const DB_KEY = 'ot_system_data_v2';
    const SETTINGS_KEY = 'ot_system_settings_v3'; 
    
    // --- å‡æœŸæ•¸æ“šåº« (2025-2027) ---
    const holidayData = {
        '2025-10-01': 'åœ‹æ…¶', '2025-10-07': 'ä¸­ç§‹ç¿Œæ—¥', '2025-10-29': 'é‡é™½', '2025-12-25': 'è–èª•', '2025-12-26': 'è–èª•ç¿Œæ—¥',

        '2026-01-01': 'å…ƒæ—¦', '2026-02-17': 'å¹´åˆä¸€', '2026-02-18': 'å¹´åˆäºŒ', '2026-02-19': 'å¹´åˆä¸‰',
        '2026-04-03': 'è€¶ç©Œå—é›£', '2026-04-04': 'å—é›£ç¿Œæ—¥', '2026-04-06': 'æ¸…æ˜ç¿Œæ—¥', '2026-04-07': 'å¾©æ´»ç¿Œæ—¥',
        '2026-05-01': 'å‹å‹•ç¯€', '2026-05-25': 'ä½›èª•ç¿Œæ—¥', '2026-06-19': 'ç«¯åˆç¯€', '2026-07-01': 'å›æ­¸',
        '2026-09-26': 'ä¸­ç§‹ç¿Œæ—¥', '2026-10-01': 'åœ‹æ…¶', '2026-10-19': 'é‡é™½', '2026-12-25': 'è–èª•', '2026-12-26': 'è–èª•ç¿Œæ—¥',

        '2027-01-01': 'å…ƒæ—¦', '2027-02-06': 'å¹´åˆä¸€', '2027-02-08': 'å¹´åˆä¸‰', '2027-02-09': 'å¹´åˆå››',
        '2027-03-26': 'è€¶ç©Œå—é›£', '2027-03-27': 'å—é›£ç¿Œæ—¥', '2027-03-29': 'å¾©æ´»ç¿Œæ—¥', '2027-04-05': 'æ¸…æ˜ç¯€',
        '2027-05-01': 'å‹å‹•ç¯€', '2027-05-14': 'ä½›èª•', '2027-06-09': 'ç«¯åˆç¯€', '2027-07-01': 'å›æ­¸',
        '2027-09-16': 'ä¸­ç§‹ç¿Œæ—¥', '2027-10-01': 'åœ‹æ…¶', '2027-10-08': 'é‡é™½', '2027-12-25': 'è–èª•', '2027-12-27': 'è–èª•å¾Œå‘¨ä¸€'
    };

    let currentDate = new Date(2026, 1, 1);
    let selectedDateStr = '';
    let appData = [];
    let userSettings = { alQuota: 14, alCarry: 0 };

    // --- åˆå§‹åŒ– ---
    window.addEventListener('load', function() {
        document.getElementById('disclaimerModal').classList.add('show');
        initTimeOptions(); 
        loadData();        
        renderCalendar();  
        
        document.body.addEventListener('touchstart', function() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }, {once:true});
    });

    function closeDisclaimer() {
        document.getElementById('disclaimerModal').classList.remove('show');
        if (!localStorage.getItem(SETTINGS_KEY)) openSettings();
    }

    function loadData() {
        const savedData = localStorage.getItem(DB_KEY);
        if (savedData) appData = JSON.parse(savedData);
        const savedSettings = localStorage.getItem(SETTINGS_KEY);
        if (savedSettings) userSettings = JSON.parse(savedSettings);
        if (userSettings.alCarry === undefined) userSettings.alCarry = 0;
        calculateBalance();
        renderRecords();
    }

    function initTimeOptions() {
        let otHtml = '<option value="" disabled selected>-- è«‹é¸æ“‡æ™‚æ•¸ --</option>';
        for (let i = 0.5; i <= 8.0; i += 0.5) otHtml += `<option value="${i}">${i} å°æ™‚</option>`;
        document.getElementById('hoursOT').innerHTML = otHtml;
        
        let compHtml = '<option value="" disabled selected>-- è«‹é¸æ“‡æ™‚æ•¸ --</option>';
        for (let i = 0.5; i <= 5.0; i += 0.5) compHtml += `<option value="${i}">${i} å°æ™‚</option>`;
        document.getElementById('hoursComp').innerHTML = compHtml;
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        document.getElementById('currentMonthLabel').innerText = `${year}å¹´ ${month + 1}æœˆ`;
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDayIndex = firstDay.getDay();

        const container = document.getElementById('calendarDays');
        container.innerHTML = '';

        for (let i = 0; i < startDayIndex; i++) container.innerHTML += `<div></div>`;

        for (let day = 1; day <= lastDay.getDate(); day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const holidayName = holidayData[dateStr] || '';
            const isSunday = new Date(year, month, day).getDay() === 0;
            const isSelected = dateStr === selectedDateStr;
            const hasRecord = appData.some(r => r.date === dateStr);

            let classes = `calendar-day ${isSunday ? 'sunday' : ''} ${holidayName ? 'holiday' : ''} ${isSelected ? 'selected' : ''}`;

            container.innerHTML += `
                <div class="${classes}" onclick="tap(); selectDate('${dateStr}')">
                    <span>${day}</span>
                    ${holidayName ? `<span class="holiday-name">${holidayName}</span>` : ''}
                    ${hasRecord ? '<div class="dot"></div>' : ''}
                </div>
            `;
        }
    }

    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    }

    // --- æ ¸å¿ƒäº’å‹•ï¼šé¸æ“‡æ—¥æœŸ (æ–°å¢) ---
    function selectDate(dateStr) {
        selectedDateStr = dateStr;
        renderCalendar(); // Highlight
        resetForm(); // é‡ç½®

        // é¡¯ç¤º Popup
        document.getElementById('inputSection').classList.add('active');
        
        // è¨­å®šæ¨™é¡Œ
        let label = dateStr;
        if (holidayData[dateStr]) label += ` (${holidayData[dateStr]})`;
        document.getElementById('selectedDateLabel').innerText = label;
    }

    function closeInput() {
        document.getElementById('inputSection').classList.remove('active');
        selectedDateStr = '';
        renderCalendar();
    }

    function updateFormUI() {
        const type = document.getElementById('typeSelect').value;
        
        ['formOT', 'formComp', 'formPH', 'formAL'].forEach(id => document.getElementById(id).classList.add('hidden'));

        if (!type) return;

        if (type === 'OT') document.getElementById('formOT').classList.remove('hidden');
        if (type === 'Comp') document.getElementById('formComp').classList.remove('hidden');
        if (type === 'PH') document.getElementById('formPH').classList.remove('hidden');
        if (type === 'AL') document.getElementById('formAL').classList.remove('hidden');

        if (type === 'PH') {
            updatePHOptions(selectedDateStr);
        }
        
        document.getElementById('saveBtn').disabled = false;
        document.getElementById('phWarning').style.display = 'none';
    }

    function updatePHOptions(referenceDateStr) {
        const phSelect = document.getElementById('sourcePH');
        phSelect.innerHTML = '<option value="" disabled selected>-- è«‹é¸æ“‡ä¾†æº --</option>';

        // æª¢æŸ¥å·²ç”¨éçš„
        const usedHolidays = new Set(appData.filter(r => r.type === 'PH').map(r => r.sourcePH));
        const refDate = new Date(referenceDateStr);

        const sortedHolidays = Object.entries(holidayData).sort((a, b) => new Date(b[0]) - new Date(a[0]));

        for (const [dateStr, name] of sortedHolidays) {
            const hDate = new Date(dateStr);
            const diffTime = refDate - hDate;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < -30 || diffDays > 90) continue; 

            const isUsed = usedHolidays.has(`${name} (${dateStr})`);
            const isTooEarly = hDate >= refDate; 

            let labelText = `${name} (${dateStr})`;
            let disabledAttr = '';
            let style = '';

            if (isUsed) {
                labelText = `${name} (å·²å®‰æ’)`;
                disabledAttr = 'disabled';
                style = 'color:#aaa';
            } else if (isTooEarly) {
                labelText = `${name} (æ—¥å­ä¸èƒ½æ—©æ–¼å…¬çœ¾å‡æœŸ)`;
                disabledAttr = 'disabled';
                style = 'color:#ddd';
            }
            
            phSelect.innerHTML += `<option value="${name} (${dateStr})" ${disabledAttr} style="${style}" data-date="${dateStr}">${labelText}</option>`;
        }
    }

    function checkPHValidity() {
        const select = document.getElementById('sourcePH');
        if (!selectedDateStr || !select.value) return;

        const holidayDateStr = select.options[select.selectedIndex].getAttribute('data-date');
        const hDate = new Date(holidayDateStr);
        const aDate = new Date(selectedDateStr);
        const saveBtn = document.getElementById('saveBtn');
        const warning = document.getElementById('phWarning');
        
        if (aDate <= hDate) {
            warning.style.display = 'block';
            warning.innerText = `âŒ éŒ¯èª¤ï¼šè£œå‡æ—¥å­å¿…é ˆåœ¨å…¬çœ¾å‡æœŸä¹‹å¾Œï¼`;
            saveBtn.disabled = true; 
            return;
        }

        const diffDays = Math.ceil(Math.abs(aDate - hDate) / (1000 * 60 * 60 * 24));
        if (diffDays > 60) {
            warning.style.display = 'block';
            warning.innerText = `âš ï¸ åš´é‡ï¼šå·²éæœŸ ${diffDays} æ—¥ (é™æœŸ60æ—¥)ï¼ç„¡æ³•ç”³è«‹ã€‚`;
            saveBtn.disabled = true; 
        } else {
            warning.style.display = 'none';
            saveBtn.disabled = false; 
        }
    }

    function resetForm() {
        document.getElementById('typeSelect').value = ""; 
        document.getElementById('remarks').value = '';     
        document.getElementById('hoursOT').value = "";    
        document.getElementById('hoursComp').value = "";
        document.getElementById('sourcePH').value = "";
        document.getElementById('saveBtn').disabled = false; 
        document.getElementById('phWarning').style.display = 'none';
        
        ['formOT', 'formComp', 'formPH', 'formAL'].forEach(id => document.getElementById(id).classList.add('hidden'));
    }

    function saveRecord() {
        if (!selectedDateStr) { alert("è«‹é¸æ“‡æ—¥æœŸ"); return; }
        
        const type = document.getElementById('typeSelect').value;
        if (!type) { alert("âš ï¸ è«‹é¸æ“‡é¡åˆ¥ï¼"); return; }

        let hours = 0, days = 0, sourcePH = '', remarks = document.getElementById('remarks').value;

        if (type === 'OT') {
            const val = document.getElementById('hoursOT').value;
            if (!val) { alert("âš ï¸ è«‹é¸æ“‡ OT æ™‚æ•¸ï¼"); return; }
            hours = parseFloat(val);
        }
        else if (type === 'Comp') {
            const val = document.getElementById('hoursComp').value;
            if (!val) { alert("âš ï¸ è«‹é¸æ“‡è£œé˜æ™‚æ•¸ï¼"); return; }
            hours = -parseFloat(val);
        }
        else if (type === 'PH') {
            sourcePH = document.getElementById('sourcePH').value;
            if (!sourcePH) { alert("âš ï¸ è«‹é¸æ“‡å…¬çœ¾å‡æœŸä¾†æºï¼"); return; }
            
            const select = document.getElementById('sourcePH');
            const holidayDateStr = select.options[select.selectedIndex].getAttribute('data-date');
            const hDate = new Date(holidayDateStr);
            const aDate = new Date(selectedDateStr);
            const diffDays = Math.ceil(Math.abs(aDate - hDate) / (1000 * 60 * 60 * 24));

            if (aDate <= hDate) { alert("âŒ éŒ¯èª¤ï¼šè£œå‡æ—¥å­å¿…é ˆåœ¨å…¬çœ¾å‡æœŸä¹‹å¾Œï¼"); return; }
            if (diffDays > 60) { alert("âŒ éŒ¯èª¤ï¼šè£œå‡å·²éæœŸ (è¶…é60æ—¥)ï¼Œç³»çµ±æ‹’çµ•å­˜æª”ã€‚"); return; }

            days = -1;
            remarks = `[è£œ] ${sourcePH} ` + remarks;
        } 
        else if (type === 'AL') {
            days = -1;
            remarks = `[å¹´å‡] ` + remarks;
            
            let currentUsed = appData.filter(r => r.type === 'AL').length;
            let totalQuota = userSettings.alQuota + userSettings.alCarry;
            let balance = totalQuota - currentUsed;
            
            if (balance <= -3) { alert("âŒ éŒ¯èª¤ï¼šå·²é”åˆ°é æ”¯ä¸Šé™ (3æ—¥)ï¼ç„¡æ³•å†ç”³è«‹å¹´å‡ã€‚"); return; }
            if (balance <= 0) {
                const confirmAdvance = confirm(`âš ï¸ æ³¨æ„ï¼š\nä½ ç¾æœ‰çš„å¹´å‡é¡åº¦å·²ç”¨ç›¡ã€‚\n\nç¢ºèªè¦ã€Œé æ”¯ã€ä¸‹å¹´åº¦å¹´å‡å—ï¼Ÿ\n(ç›®å‰é æ”¯ç¬¬ ${Math.abs(balance) + 1} / 3 æ—¥)`);
                if (!confirmAdvance) return; 
            }
        }

        const newRecord = {
            id: Date.now(),
            date: selectedDateStr, 
            type: type,
            hours: hours,
            days: days,
            sourcePH: sourcePH, 
            remarks: remarks
        };

        appData.unshift(newRecord);
        localStorage.setItem(DB_KEY, JSON.stringify(appData));
        resetForm();
        closeInput();
        loadData();
    }

    function deleteRecord(id) {
        if (!confirm("ç¢ºå®šåˆªé™¤æ­¤è¨˜éŒ„ï¼Ÿ")) return;
        appData = appData.filter(r => r.id !== id);
        localStorage.setItem(DB_KEY, JSON.stringify(appData));
        loadData();
        renderCalendar();
    }

    function calculateBalance() {
        let balOT = 0, phUsed = 0, alUsed = 0;
        appData.forEach(r => {
            if (r.type === 'OT' || r.type === 'Comp') balOT += r.hours;
            if (r.type === 'PH') phUsed += 1;
            if (r.type === 'AL') alUsed += 1;
        });

        const elOT = document.getElementById('balanceOT');
        if (balOT > 0) {
            elOT.innerHTML = `OT: +${balOT}<small> hrs</small>`;
            elOT.className = 'stat-value text-green';
        } else if (balOT < 0) {
            elOT.innerHTML = `æ¬ : ${balOT}<small> hrs</small>`;
            elOT.className = 'stat-value text-red';
        } else {
            elOT.innerHTML = `0`;
            elOT.className = 'stat-value';
        }

        document.getElementById('balancePH').innerHTML = `${17 - phUsed} <small>/ 17</small>`;
        
        let totalAL = userSettings.alQuota + userSettings.alCarry;
        let balanceAL = totalAL - alUsed;
        
        let alText = balanceAL;
        let alClass = 'stat-value';
        
        if (balanceAL < 0) {
            alText = `é æ”¯ ${Math.abs(balanceAL)}`;
            alClass = 'stat-value text-red';
        } else {
            alClass = 'stat-value text-blue';
        }
        
        document.getElementById('balanceAL').innerHTML = `<span class="${alClass}">${alText}</span> <small>/ ${totalAL}</small>`;
    }

    function renderRecords() {
        const list = document.getElementById('recordList');
        list.innerHTML = '';
        
        if (appData.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">æš«ç„¡è¨˜éŒ„</div>';
            return;
        }

        const sorted = [...appData].sort((a,b) => new Date(b.date) - new Date(a.date));

        sorted.forEach(r => {
            let val = (r.type === 'OT' || r.type === 'Comp') ? `${Math.abs(r.hours)} hrs` : '1 æ—¥';
            let color = r.hours > 0 ? 'green' : (r.hours < 0 ? 'orange' : '#333');
            if (r.type === 'PH') color = '#d63384';
            if (r.type === 'AL') color = 'blue';

            let displayRemark = r.remarks ? r.remarks.replace(/^\[.*?\]\s*/, '') : '';

            list.innerHTML += `
                <div class="record-item">
                    <div class="record-info">
                        <strong>${r.date}</strong> <span style="color:${color};font-weight:bold;margin-left:5px;">${r.type}</span> <span style="font-size:0.8rem;color:#888;">${val}</span><br>
                        <span style="color:#666; font-size:0.85rem;">${displayRemark}</span>
                    </div>
                    <div class="record-actions">
                        <button onclick="tap(); deleteRecord(${r.id})">ğŸ—‘ï¸ åˆªé™¤</button>
                    </div>
                </div>
            `;
        });
    }

    function openSettings() {
        document.getElementById('settingsModal').classList.add('show');
        document.getElementById('alQuotaSelect').value = userSettings.alQuota;
        document.getElementById('alCarrySelect').value = userSettings.alCarry;
    }
    function saveSettings() {
        userSettings.alQuota = parseInt(document.getElementById('alQuotaSelect').value);
        userSettings.alCarry = parseInt(document.getElementById('alCarrySelect').value);
        
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(userSettings));
        document.getElementById('settingsModal').classList.remove('show');
        loadData();
    }
    function resetAll() {
        if (confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰è¨˜éŒ„ï¼ç„¡æ³•å¾©åŸï¼")) {
            localStorage.removeItem(DB_KEY);
            location.reload();
        }
    }
</script>
</body>
</html>